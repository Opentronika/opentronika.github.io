---
import { getLangFromUrl, useTranslations } from '../i18n/utils'; 
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<div class="space-y-4 p-4 border rounded-lg shadow-xl bg-neutral-850 ">
    <h2 class="text-3xl font-bold text-white mb-6">ðŸ“° {t("News")}</h2>

    <div id="reddit-feed-container" class="grid gap-6 max-h-160 overflow-y-auto">
        <p id="reddit-loading" class="text-gray-500">{t("Noposts")}</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('reddit-feed-container');
        const loadingElement = document.getElementById('reddit-loading');
        const REDDIT_URL = "https://www.reddit.com/r/OpenTronika.json";

        try {
            const response = await fetch(REDDIT_URL, {
                headers: {
                    'User-Agent': 'AstroRedditFeedComponent/1.0',
                },
            });

            if (!response.ok) {
                throw new Error(`Error fetching data: ${response.statusText}`);
            }

            const data = await response.json();
            const posts = data.data.children.filter((child) => child.data.title);

            if (loadingElement) {
                loadingElement.remove();
            }

            if (posts.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No posts found.</p>';
                return;
            }

            posts.forEach((post) => {
                const postData = post.data;
                const postUrl = `https://www.reddit.com${postData.permalink}`;
                const targetUrl = postData.url.startsWith("http") ? postData.url : postUrl;
                
                const article = document.createElement('a');
                article.href = targetUrl;
                article.target = '_blank';
                article.rel = 'noopener noreferrer';
                article.className = 'focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded';

                let selftext = postData.selftext || '';
                if (selftext.length > 300) {
                    selftext = `${selftext.slice(0, 300)}...`;
                }

                article.innerHTML = `
                    <article class="p-4 border rounded-lg hover:shadow-md transition duration-300">
                        <h3 class="text-xl font-semibold mb-2 text-white">
                            ${postData.title}
                        </h3>
                        <div>
                            <p class="text-gray-500">${selftext}</p>
                        </div>
                    </article>
                `;
                container.appendChild(article);
            });

        } catch (error) {
            console.error(error);
            if (loadingElement) {
                loadingElement.remove();
            }
            container.innerHTML = `<p class="text-red-600 font-medium">Doesn't load the posts.</p>`;
        }
    });
</script>
